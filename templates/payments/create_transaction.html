{% extends "base.html" %}
{% block title %}Create Transaction{% endblock %}

{% block content %}
    <div class="page-body">
        <div class="card card-form">
            <div class="card-body">
                <style>
                  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
                  .form-grid>.mb-3{margin-bottom:0!important}
                  .form-grid .form-label{font-weight:600;font-size:.92rem;margin-bottom:6px}
                  .form-grid input[type="text"],
                  .form-grid input[type="number"],
                  .form-grid input[type="date"],
                  .form-grid input[type="email"],
                  .form-grid select,
                  .form-grid textarea{width:100%}
                  .form-text{font-size:.8rem;color:#6b7280}
                  .invalid-feedback.d-block{font-size:.8rem}
                  /* readonly end-date visual */
                  .readonly-field{background:#f3f4f6;color:#6b7280;cursor:not-allowed}
                  input[type="date"]{line-height:1.2}
                  /* Field highlight on focus / value */
                  .form-highlight{padding:6px;border-radius:10px;transition:background .15s ease, box-shadow .15s ease}
                  .form-highlight .form-label{transition:color .15s ease}
                  .form-highlight:focus-within{background:#f3f8ff;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
                  .form-highlight:focus-within .form-label{color:#2563eb}
                  .form-highlight.has-value .form-label{color:#111827;font-weight:600}
                </style>
                <h5 class="mb-3">Create Transaction</h5>

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                {% endif %}

                <form method="post" novalidate>
                    {% csrf_token %}
                    <div class="form-grid">
                      {% for field in form.visible_fields %}
                        <div class="mb-3 form-highlight" data-field="{{ field.name }}">
                          <label class="form-label" for="{{ field.id_for_label }}">
                            {{ field.label }}{% if field.field.required %} <span style="color:#dc2626">*</span>{% endif %}
                          </label>
                          {{ field }}
                          {% if field.help_text %}
                            <div class="form-text">{{ field.help_text }}</div>
                          {% endif %}
                          {% for e in field.errors %}
                            <div class="invalid-feedback d-block">{{ e }}</div>
                          {% endfor %}
                        </div>
                      {% endfor %}
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit">Save</button>
                        <a class="btn btn-outline-secondary" href="{% url 'payments:list' %}">Cancel</a>
                    </div>
                    <script>
                      (function(){
                        var form = document.currentScript.closest('form') || document.querySelector('form');
                        if(!form) return;
                        var fields = form.querySelectorAll('input, select, textarea');
                        fields.forEach(function(el){
                          var box = el.closest('.form-highlight');
                          if(!box) return;
                          function sync(){
                            if((el.value||'').trim()!=='') box.classList.add('has-value');
                            else box.classList.remove('has-value');
                          }
                          el.addEventListener('focus', function(){ box.classList.add('is-focus'); });
                          el.addEventListener('blur', function(){ box.classList.remove('is-focus'); sync(); });
                          el.addEventListener('input', sync);
                          el.addEventListener('change', sync);
                          sync();
                        });
                      })();
                    </script>
                    <script>
                        (function () {
                            var form = document.currentScript.closest('form');
                            if (!form) return;

                            function qField(name, selectors) {
                                var scope = form.querySelector('[data-field="' + name + '"]');
                                if (!scope) return null;
                                return scope.querySelector(selectors);
                            }

                            // Field handles
                            var recordEl = qField('record', 'select, input');
                            var amountEl = qField('amount', 'input');
                            var startDateEl = qField('start_date', 'input');
                            var endDateEl   = qField('end_date', 'input');
                            var paidOnEl   = qField('paid_on', 'input') || qField('paid_date', 'input');

                            // 1) Enforce native date picker + readonly end date
                            if (startDateEl) {
                                try { startDateEl.type = 'date'; } catch(e) {}
                                startDateEl.setAttribute('inputmode','none');
                                startDateEl.setAttribute('autocomplete','off');
                                startDateEl.addEventListener('change', function(){
                                    if (!endDateEl || !this.value) return;
                                    var d = new Date(this.value);
                                    if (!isNaN(d.getTime())) {
                                        d.setFullYear(d.getFullYear() + 1);
                                        endDateEl.value = d.toISOString().slice(0,10);
                                    }
                                });
                            }
                            // Paid on: enforce native date picker
                            if (paidOnEl) {
                                try { paidOnEl.type = 'date'; } catch(e) {}
                                paidOnEl.setAttribute('inputmode','none');
                                paidOnEl.setAttribute('autocomplete','off');
                            }
                            if (endDateEl) {
                                endDateEl.readOnly = true; // submitted but not editable
                                endDateEl.classList.add('readonly-field');
                                endDateEl.setAttribute('aria-readonly','true');
                                endDateEl.setAttribute('title','End date is calculated automatically');
                                endDateEl.addEventListener('keydown', function(ev){ ev.preventDefault(); });
                                endDateEl.addEventListener('beforeinput', function(ev){ ev.preventDefault(); });
                            }

                            // 2) Amount must be float
                            if (amountEl) {
                                amountEl.setAttribute('type','number');
                                amountEl.setAttribute('step','0.01');
                                amountEl.setAttribute('min','0');
                                amountEl.setAttribute('inputmode','decimal');
                                amountEl.addEventListener('input', function(){
                                    // normalize comma decimal to dot
                                    this.value = this.value.replace(',', '.');
                                });
                            }

                            // 3) Fetch/derive amount from selected record option or API
                            function parsePrice(text) {
                                // Match $9,999.99, ₹9,999, €1.234,56 (we normalize commas for EN style)
                                var m = text && text.match(/[\$€£₹]\s*([0-9][0-9,]*(?:\.[0-9]{1,2})?)/);
                                if (!m) return null;
                                return m[1].replace(/,/g, '');
                            }
                            function setAmount(val){ if(amountEl && (val || val===0)) amountEl.value = Number(val).toFixed(2); }

                            function syncAmount() {
                                if (!recordEl || !amountEl) return;
                                // Prefer data-amount attribute if present
                                var labelText = '';
                                var dataAmt = null;
                                if (recordEl.tagName === 'SELECT') {
                                    var opt = recordEl.options[recordEl.selectedIndex];
                                    if (opt) {
                                        labelText = opt.textContent || '';
                                        if (opt.dataset && opt.dataset.amount != null && opt.dataset.amount !== '') {
                                            dataAmt = opt.dataset.amount;
                                        }
                                    }
                                } else {
                                    labelText = recordEl.value || '';
                                }
                                if (dataAmt != null) {
                                    setAmount(dataAmt);
                                    return;
                                }
                                var price = parsePrice(labelText);
                                if (price !== null) {
                                    setAmount(price);
                                }
                            }

                            // Initial fill and when record changes
                            syncAmount();
                            if (recordEl) recordEl.addEventListener('change', syncAmount);
                        })();
                    </script>
                </form>
            </div>
        </div>
    </div>
{% endblock %}