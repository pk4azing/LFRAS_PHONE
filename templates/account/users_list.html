{% extends "base.html" %}
{% load static %}
{% block title %}Lucid Staff · Lucid{% endblock %}

{% block content %}
  <div class="page-body">
    <div class="container-fluid py-3">
      <style>
        /* Users list page scoped styles */
        .user-card {
          border-radius: 1rem;
          box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
          overflow: hidden;
          background: #fff;
          display: flex;
          flex-direction: column;
          height: 100%;
        }
        .user-card .header {
          background: linear-gradient(135deg, #4f46e5, #3b82f6);
          padding: 2.25rem 1rem 3.25rem;
          position: relative;
          text-align: center;
          color: #fff;
          border-top-left-radius: 1rem;
          border-top-right-radius: 1rem;
        }
        /* Role-based card header backgrounds */
        .user-card .header.lad { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .user-card .header.lus { background: linear-gradient(135deg, #2563eb, #3b82f6); }
        .user-card .avatar {
          width: 96px;
          height: 96px;
          border-radius: 50%;
          object-fit: cover;
          border: 4px solid rgba(255,255,255,0.8);
          position: absolute;
          left: 50%;
          bottom: -48px;
          transform: translateX(-50%);
          background: #fff;
          box-shadow: 0 0 0 4px rgba(255,255,255,0.6);
        }
        .user-card .header h5 {
          margin-top: 4rem;
          margin-bottom: 0.25rem;
          font-weight: 600;
          font-size: 1.25rem;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          color: #fff;
        }
        .user-card .role-badge {
          --_bg: var(--bs-primary-bg-subtle);
          --_text: var(--bs-primary-text-emphasis);
          --_border: var(--bs-primary-border-subtle);
          background: var(--_bg);
          color: var(--_text);
          border: 1px solid var(--_border);
          font-weight: 600;
          font-size: 0.75rem;
          padding: 0.25em 0.75em;
          border-radius: 9999px;
          display: inline-block;
          margin-bottom: 0.5rem;
          white-space: nowrap;
        }
        /* Role-specific emphasis */
        .user-card .role-badge.lad{
          --_bg: var(--bs-success-bg-subtle);
          --_text: var(--bs-success-text-emphasis);
          --_border: var(--bs-success-border-subtle);
        }
        .user-card .role-badge.lus{
          --_bg: var(--bs-primary-bg-subtle);
          --_text: var(--bs-primary-text-emphasis);
          --_border: var(--bs-primary-border-subtle);
        }
        .user-card .socials {
          display: flex;
          justify-content: center;
          gap: 1rem;
          margin-top: 2.25rem;   /* clears the overlapping avatar */
          margin-bottom: 1rem;
          color: #6b7280;
          font-size: 1.25rem;
        }
        .user-card .socials .social-btn{
          width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;
          border-radius: 999px; text-decoration: none; color: inherit;
          background: rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.06);
          transition: background .2s ease, color .2s ease, border-color .2s ease, transform .1s ease;
        }
        .user-card .socials .social-btn:hover{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); color:#3b82f6; transform: translateY(-1px); }
        .user-card .socials .social-btn:focus{ outline: 2px solid #93c5fd; outline-offset: 2px; }
        .user-card .socials i {
          cursor: pointer;
          transition: color 0.3s ease;
        }
        .user-card .socials i:hover {
          color: #3b82f6;
        }
        .user-card .socials [data-feather] { vertical-align: middle; }
        .user-card .stats {
          display: flex;
          justify-content: space-around;
          border-top: 1px solid #e5e7eb;
          padding: 1rem 0;
          font-size: 0.875rem;
          color: #6b7280;
        }
        .user-card .stats .stat {
          text-align: center;
          flex: 1;
        }
        .user-card .stats .stat strong {
          display: block;
          font-weight: 600;
          font-size: 1.125rem;
          color: #111827;
        }
        .user-card .status-dot {
          position: absolute;
          top: 0.75rem;
          right: 0.75rem;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          border: 2px solid #fff;
          box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .user-card .status-dot.active {
          background: #198754;
        }
        .user-card .status-dot.inactive {
          background: #6c757d;
        }
        .user-card .card-actions {
          padding: 0.75rem 1rem 1rem;
          display: grid;
          grid-template-columns: 1fr;
          gap: .75rem;
          background: #fff;
          border-top: 1px solid #eef1f5;
        }
        @media (min-width: 576px){
          .user-card .card-actions{ grid-template-columns: 1fr 1fr; }
        }
        .btn-soft-primary, .btn-soft-danger, .btn-soft-success{
          border: 1px solid rgba(0,0,0,.08);
          background: #f8f9ff;
          color: #4f46e5;
        }
        .btn-soft-danger{ background:#fff5f5; color:#dc3545; }
        .btn-soft-success{ background:#f3fff7; color:#198754; }
        .btn-soft-primary:hover{ background:#eef0ff; }
        .btn-soft-danger:hover{ background:#ffecec; }
        .btn-soft-success:hover{ background:#e7fff0; }
      </style>
      <div class="row align-items-center mb-3">
        <div class="col">
          <h4 class="mb-0">Lucid Staff</h4>
          <small class="text-muted">Total: {{ total }}</small>
        </div>
        <div class="col-auto">
          <a class="btn btn-primary" href="{% url 'accounts:create_staff' %}"><i data-feather="user-plus" class="me-1"></i>Add Staff</a>
        </div>
      </div>

      <form method="get" class="row g-2 align-items-center mb-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i data-feather="search"></i></span>
            <input type="search" name="q" value="{{ q }}" class="form-control" placeholder="Search email, name, phone…">
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="status" onchange="this.form.submit()">
            <option value="" {% if not status %}selected{% endif %}>All statuses</option>
            <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="role" onchange="this.form.submit()">
            <option value="" {% if not role %}selected{% endif %}>All roles</option>
            <option value="LAD" {% if role == 'LAD' %}selected{% endif %}>LAD (Admin)</option>
            <option value="LUS" {% if role == 'LUS' %}selected{% endif %}>LUS (Lucid User)</option>
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-secondary" type="submit">Filter</button>
        </div>
      </form>

      <!-- Card Grid -->
      <div class="row g-4">
        {% for u in page_obj %}
          <div class="col-12 col-sm-6 col-md-4 col-xl-3">
            <div class="user-card shadow-sm">
              <div class="header position-relative {{ u.role|lower }}">
                {% if u.profile_photo %}
                  <img src="{{ u.profile_photo.url }}" alt="{{ u.get_full_name|default:u.email }}" class="avatar shadow-sm">
                {% else %}
                  <img src="{% static 'mofi/images/user/user.png' %}" alt="Avatar" class="avatar shadow-sm">
                {% endif %}
                <span class="status-dot {% if u.is_active %}active{% else %}inactive{% endif %}"></span>
                <h5>
                  {% if u.get_full_name %}
                    {{ u.get_full_name }}
                  {% elif u.last_name or u.first_name %}
                    {{ u.last_name }}, {{ u.first_name }}
                  {% else %}
                    {{ u.email }}
                  {% endif %}
                </h5>
                <p class="text-light small mb-0">{{ u.email }}</p>
                <span class="role-badge {{ u.role|lower }}">{{ u.role }}</span>
                <div class="mt-1">
                  {% if u.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </div>
              </div>
              <div class="card-actions">
                <a class="btn btn-soft-primary w-100" href="{% url 'accounts:user_edit' u.id %}">
                  <i data-feather="edit-2" class="me-1"></i>Edit
                </a>
                <form method="post" action="{% url 'accounts:user_toggle_active' u.id %}" class="m-0 w-100">
                  {% csrf_token %}
                  {% if u.is_active %}
                    <button type="submit" class="btn btn-soft-danger w-100"><i data-feather="slash" class="me-1"></i>Deactivate</button>
                  {% else %}
                    <button type="submit" class="btn btn-soft-success w-100"><i data-feather="check" class="me-1"></i>Activate</button>
                  {% endif %}
                </form>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center text-muted py-5">No staff found.</div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if page_obj.paginator.num_pages > 1 %}
        <div class="pt-3 d-flex justify-content-center">
          <nav>
            <ul class="pagination mb-0">
              {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?q={{ q }}&status={{ status }}&role={{ role }}&page={{ page_obj.previous_page_number }}">Prev</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Prev</span></li>
              {% endif %}

              <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

              {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?q={{ q }}&status={{ status }}&role={{ role }}&page={{ page_obj.next_page_number }}">Next</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}

    </div>
  </div>
{% endblock %}