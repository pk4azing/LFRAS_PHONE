{% extends "base.html" %}
{% load static %}
{% load form_extras %}

{% block title %}Create Evaluator{% endblock %}

{% block content %}
    <div class="page-body">
        <div class="container-fluid">
            {% include "partials/_alerts.html" %}

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <h5 class="mb-0">
                                <svg class="feather me-2">
                                    <use href="{% static 'mofi/svg/icon-sprite.svg' %}#stroke-user"></use>
                                </svg>
                                New Evaluator
                            </h5>
                            <a href="{% url 'tenants:evaluator_detail' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-left-short me-1"></i>Back to list
                            </a>
                        </div>

                        <div class="card-body">
                            <form method="post" novalidate>
                                {% csrf_token %}

                                <!-- Company -->
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2">Company</h6>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Company Name</label>
                                        <input type="text" name="{{ form.name.name }}"
                                               value="{{ form.name.value|default_if_none:'' }}"
                                               class="form-control{% if form.name.errors %} is-invalid{% endif %}"
                                               placeholder="Acme, Inc.">
                                        {% if form.name.help_text %}
                                            <div class="form-text">{{ form.name.help_text }}</div>{% endif %}
                                        {% for e in form.name.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Website</label>
                                        <div class="input-group">
                                            <span class="input-group-text">https://</span>
                                            <input type="text" name="{{ form.website.name }}"
                                                   value="{{ form.website.value|default_if_none:'' }}"
                                                   class="form-control{% if form.website.errors %} is-invalid{% endif %}"
                                                   placeholder="acme.com">
                                        </div>
                                        {% for e in form.website.errors %}
                                            <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Email Domain</label>
                                        <div class="input-group">
                                            <span class="input-group-text">@</span>
                                            <input type="text" name="{{ form.email_domain.name }}"
                                                   value="{{ form.email_domain.value|default_if_none:'' }}"
                                                   class="form-control{% if form.email_domain.errors %} is-invalid{% endif %}"
                                                   placeholder="acme.com">
                                        </div>
                                        <div class="form-text">Employees must use this domain.</div>
                                        {% for e in form.email_domain.errors %}
                                            <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Subdomain</label>
                                        <div class="input-group">
                                            <input type="text" id="id_subdomain" name="{{ form.subdomain.name }}"
                                                   value="{{ form.subdomain.value|default_if_none:'' }}"
                                                   class="form-control{% if form.subdomain.errors %} is-invalid{% endif %}"
                                                   placeholder="acme">
                                            <span class="input-group-text">.lucidcompliances.com</span>
                                        </div>
                                        <div class="form-text">Used for evaluator user invitations.</div>
                                        {% for e in form.subdomain.errors %}
                                            <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                                    </div>
                                </div>

                                <!-- Address -->
                                <div class="row g-3 mt-4">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2">Address</h6>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="form-label">Address line 1</label>
                                        <input type="text" name="{{ form.address_line1.name }}"
                                               value="{{ form.address_line1.value|default_if_none:'' }}"
                                               class="form-control{% if form.address_line1.errors %} is-invalid{% endif %}">
                                        {% for e in form.address_line1.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-5">
                                        <label class="form-label">Address line 2</label>
                                        <input type="text" name="{{ form.address_line2.name }}"
                                               value="{{ form.address_line2.value|default_if_none:'' }}"
                                               class="form-control{% if form.address_line2.errors %} is-invalid{% endif %}">
                                        {% for e in form.address_line2.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">City</label>
                                        <input type="text" name="{{ form.city.name }}"
                                               value="{{ form.city.value|default_if_none:'' }}"
                                               class="form-control{% if form.city.errors %} is-invalid{% endif %}">
                                        {% for e in form.city.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">State</label>
                                        <input type="text" name="{{ form.state.name }}"
                                               value="{{ form.state.value|default_if_none:'' }}"
                                               class="form-control{% if form.state.errors %} is-invalid{% endif %}">
                                        {% for e in form.state.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">ZIP</label>
                                        <input type="text" name="{{ form.postal_code.name }}"
                                               value="{{ form.postal_code.value|default_if_none:'' }}"
                                               class="form-control{% if form.postal_code.errors %} is-invalid{% endif %}">
                                        {% for e in form.postal_code.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>
                                </div>

                                <!-- POC -->
                                <div class="row g-3 mt-4">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2">Point of Contact (POC)</h6>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">POC Name</label>
                                        <input type="text" name="{{ form.poc_name.name }}"
                                               value="{{ form.poc_name.value|default_if_none:'' }}"
                                               class="form-control{% if form.poc_name.errors %} is-invalid{% endif %}"
                                               placeholder="Jane Doe">
                                        {% for e in form.poc_name.errors %}
                                            <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">POC Email</label>
                                        <input type="email" name="{{ form.poc_email.name }}"
                                               value="{{ form.poc_email.value|default_if_none:'' }}"
                                               class="form-control{% if form.poc_email.errors %} is-invalid{% endif %}"
                                               placeholder="jane@acme.com">
                                        <div class="form-text">An EAD user will be auto-created for this email.</div>
                                        {% for e in form.poc_email.errors %}
                                            <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                                    </div>
                                </div>

                                <!-- Plan & Payment -->
                                <div class="row g-3 mt-4">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2">Subscription</h6>
                                    </div>

                                    {% if form.plan %}
                                        <div class="col-md-6">
                                            <label class="form-label">Plan</label>
                                            {{ form.plan|add_class:"form-select" }}
                                            {% for e in form.plan.errors %}
                                                <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                                        </div>
                                    {% endif %}

                                    {% if form.payment_id %}
                                        <div class="col-md-6">
                                            <label class="form-label">Payment / Transaction ID</label>
                                            <input type="text" name="{{ form.payment_id.name }}"
                                                   value="{{ form.payment_id.value|default_if_none:'' }}"
                                                   class="form-control{% if form.payment_id.errors %} is-invalid{% endif %}"
                                                   placeholder="PAY-XXXX">
                                            {% for e in form.payment_id.errors %}
                                                <div class="invalid-feedback">{{ e }}</div>{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Non-field errors -->
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger mt-4" role="alert">
                                        {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>
                                        {% endif %}{% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Actions -->
                                <div class="d-flex gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check2-circle me-1"></i>Create Evaluator
                                    </button>
                                    <a href="{% url 'tenants:evaluator_detail' %}" class="btn btn-light">Cancel</a>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional helpers -->
    <script>
        (function () {
            const nameEl = document.querySelector('input[name="{{ form.name.name }}"]');
            const subEl = document.getElementById('id_subdomain');
            if (nameEl && subEl && !subEl.value) {
                nameEl.addEventListener('input', function () {
                    const slug = (this.value || '')
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '')
                        .substring(0, 30);
                    if (!subEl.dataset.touched) subEl.value = slug;
                });
                subEl.addEventListener('input', function () {
                    this.dataset.touched = '1';
                });
            }
        })();
    </script>
{% endblock %}