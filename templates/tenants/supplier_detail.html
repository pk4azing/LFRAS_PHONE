{% extends "base.html" %}
{% block title %}Supplier — {{ supplier.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-1">{{ supplier.name }}</h3>
    <div class="text-muted small">Evaluator: {{ supplier.evaluator.name }}</div>
  </div>
  <div>
    {% if request.user.role in ('LAD','LUS','EAD','EVS') %}
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#rulesUploadModal">Replace Rules</button>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h6 class="mb-3">Validation Rules</h6>
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Expected Name</th>
            <th>Required</th>
            <th>Keywords</th>
            <th>Extensions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rules %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{% if r.expected_name %}{{ r.expected_name }}{% else %}{{ r.name }}{% endif %}</td>
            <td>
              {% if r.required %}<span class="badge text-bg-success">Yes</span>
              {% else %}<span class="badge text-bg-secondary">No</span>{% endif %}
            </td>
            <td>{{ r.keywords|default:"—" }}</td>
            <td>{% if r.extensions %}{{ r.extensions }}{% else %}{{ r.allowed_extensions|default:"—" }}{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted">No rules configured.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="small text-muted">
      CSV headers: <code>expected_name, required, keywords, extensions</code>
    </div>
  </div>
</div>

<!-- Replace Rules Modal -->
<div class="modal fade" id="rulesUploadModal" tabindex="-1" aria-labelledby="rulesUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" enctype="multipart/form-data" action="{% url 'tenants:rules_upload' supplier.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="rulesUploadModalLabel">Replace Validation Rules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Upload a CSV file to replace all existing rules for this supplier.</p>
        <ul class="small">
          <li>Headers: <code>expected_name, required, keywords, extensions</code></li>
          <li><code>required</code>: yes/true/1 = required</li>
          <li><code>extensions</code>: comma separated (e.g., <code>pdf,jpg,png</code>)</li>
        </ul>
        <input type="file" name="file" accept=".csv" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Replace Rules</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}